<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ‹…å½“AI ğŸ’œ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700;900&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #08080e;
    --card: #131320;
    --accent: #c9a0dc;
    --accent-dark: #8b5fa3;
    --accent-glow: rgba(201,160,220,0.25);
    --gold: #d4a574;
    --text: #f0e6f6;
    --text-sub: #8a7f96;
    --chat-bg: #0e0e1a;
    --user-bubble: linear-gradient(135deg, #c9a0dc, #8b5fa3);
    --tanto-bubble: #1e1d30;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Zen Kaku Gothic New', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    overflow-x: hidden;
  }

  /* ===== SCREEN SYSTEM ===== */
  .screen { display: none; min-height: 100dvh; flex-direction: column; }
  .screen.active { display: flex; }

  /* ===== HOME ===== */
  #home {
    align-items: center;
    justify-content: center;
    background: radial-gradient(ellipse at 50% 0%, rgba(139,95,163,0.15) 0%, transparent 60%),
                linear-gradient(180deg, var(--bg) 0%, #0f0520 100%);
    padding: 24px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  #home::before {
    content: '';
    position: absolute;
    width: 300px; height: 300px;
    background: radial-gradient(circle, rgba(201,160,220,0.08), transparent 70%);
    top: 10%; left: 50%; transform: translateX(-50%);
    pointer-events: none;
  }

  .logo-icon {
    font-size: 56px;
    filter: drop-shadow(0 0 30px rgba(201,160,220,0.5));
    margin-bottom: 20px;
    animation: float 3s ease-in-out infinite;
  }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  .logo-text {
    font-family: 'Outfit', sans-serif;
    font-size: 40px;
    font-weight: 800;
    background: linear-gradient(135deg, #c9a0dc, #f0c4ff, #d4a574);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: 3px;
    margin-bottom: 12px;
  }

  .logo-sub {
    color: var(--text-sub);
    font-size: 13px;
    line-height: 2;
    margin-bottom: 44px;
  }

  .btn-primary {
    background: var(--user-bubble);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 16px 52px;
    font-size: 16px;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    box-shadow: 0 4px 28px rgba(201,160,220,0.4);
    transition: all 0.3s;
    letter-spacing: 1px;
  }
  .btn-primary:active { transform: scale(0.97); }

  .btn-secondary {
    margin-top: 14px;
    background: none;
    color: var(--accent);
    border: 1px solid var(--accent-dark);
    border-radius: 50px;
    padding: 12px 36px;
    font-size: 14px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.3s;
  }
  .btn-secondary:active { background: rgba(201,160,220,0.1); }

  .hint-box {
    margin-top: 44px;
    padding: 20px 24px;
    background: rgba(255,255,255,0.02);
    border-radius: 16px;
    border: 1px solid rgba(201,160,220,0.08);
    max-width: 320px;
  }
  .hint-box p { color: var(--text-sub); font-size: 12px; line-height: 2; }

  /* ===== API KEY SCREEN ===== */
  #apikey {
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, var(--bg) 0%, #0f0520 100%);
    padding: 24px;
  }

  .apikey-card {
    background: var(--card);
    border-radius: 24px;
    border: 1px solid rgba(201,160,220,0.1);
    padding: 32px 24px;
    width: 100%;
    max-width: 360px;
    text-align: center;
  }

  .apikey-input {
    width: 100%;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(201,160,220,0.15);
    border-radius: 14px;
    padding: 14px 16px;
    color: var(--text);
    font-size: 13px;
    font-family: 'Outfit', monospace;
    outline: none;
    margin: 20px 0;
    transition: border-color 0.3s;
  }
  .apikey-input:focus { border-color: var(--accent); }
  .apikey-input::placeholder { color: var(--text-sub); }

  /* ===== UPLOAD ===== */
  #upload {
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, var(--bg) 0%, #0f0520 100%);
    padding: 24px;
  }

  .upload-zone {
    width: 300px;
    height: 200px;
    border: 2px dashed var(--accent-dark);
    border-radius: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: rgba(201,160,220,0.03);
    transition: all 0.3s;
  }
  .upload-zone:active {
    border-color: var(--accent);
    background: rgba(201,160,220,0.08);
  }

  .privacy-box {
    margin-top: 28px;
    padding: 16px 20px;
    background: rgba(255,255,255,0.02);
    border-radius: 14px;
    border: 1px solid rgba(201,160,220,0.08);
    max-width: 300px;
  }

  .error-box {
    margin-top: 16px;
    padding: 12px 20px;
    background: rgba(255,80,80,0.08);
    border-radius: 12px;
    border: 1px solid rgba(255,80,80,0.15);
    max-width: 300px;
  }

  /* ===== ANALYZING ===== */
  #analyzing {
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, var(--bg) 0%, #0f0520 100%);
  }

  .spinner {
    width: 56px; height: 56px;
    border-radius: 50%;
    border: 3px solid var(--accent-dark);
    border-top-color: var(--accent);
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== SELECT TANTO ===== */
  #select {
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, var(--bg) 0%, #0f0520 100%);
    padding: 24px;
  }

  .member-btn {
    width: 100%;
    max-width: 320px;
    background: var(--card);
    border: 1px solid rgba(201,160,220,0.12);
    border-radius: 16px;
    padding: 14px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 10px;
  }
  .member-btn:active {
    border-color: var(--accent);
    background: #1a1930;
  }

  .member-avatar {
    width: 42px; height: 42px;
    border-radius: 50%;
    background: var(--user-bubble);
    display: flex; align-items: center; justify-content: center;
    font-size: 17px;
    flex-shrink: 0;
  }

  /* ===== CHAT ===== */
  #chat {
    height: 100dvh;
    background: var(--chat-bg);
    display: none;
    flex-direction: column;
  }
  #chat.active {
    display: flex;
  }

  .chat-header {
    background: var(--card);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid rgba(201,160,220,0.08);
    flex-shrink: 0;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }

  .msg-row {
    display: flex;
    align-items: flex-end;
    gap: 8px;
  }
  .msg-row.user { justify-content: flex-end; }
  .msg-row.tanto { justify-content: flex-start; }

  .msg-avatar {
    width: 28px; height: 28px;
    border-radius: 50%;
    background: var(--user-bubble);
    display: flex; align-items: center; justify-content: center;
    font-size: 11px;
    flex-shrink: 0;
  }

  .msg-bubble {
    max-width: 78%;
    padding: 10px 14px;
    font-size: 14px;
    line-height: 1.7;
    word-break: break-word;
    white-space: pre-wrap;
  }
  .msg-bubble.user {
    background: var(--user-bubble);
    border-radius: 18px 18px 4px 18px;
    color: white;
  }
  .msg-bubble.tanto {
    background: var(--tanto-bubble);
    border-radius: 18px 18px 18px 4px;
    color: var(--text);
  }

  .typing-indicator {
    padding: 12px 18px;
    background: var(--tanto-bubble);
    border-radius: 18px 18px 18px 4px;
    color: var(--text-sub);
    font-size: 14px;
    display: flex;
    gap: 4px;
  }
  .typing-dot {
    animation: typingDot 1.4s infinite;
    opacity: 0.3;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingDot {
    0%, 60%, 100% { opacity: 0.3; }
    30% { opacity: 1; }
  }

  .chat-input-area {
    background: var(--card);
    padding: 12px 14px;
    display: flex;
    gap: 8px;
    align-items: flex-end;
    border-top: 1px solid rgba(201,160,220,0.08);
    flex-shrink: 0;
  }

  .chat-input {
    flex: 1;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(201,160,220,0.12);
    border-radius: 24px;
    padding: 10px 16px;
    color: var(--text);
    font-size: 14px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.3s;
  }
  .chat-input:focus { border-color: var(--accent); }
  .chat-input::placeholder { color: var(--text-sub); }

  .send-btn {
    width: 42px; height: 42px;
    border-radius: 50%;
    border: none;
    color: white;
    font-size: 15px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
  }
  .send-btn.active { background: var(--user-bubble); }
  .send-btn.inactive { background: rgba(201,160,220,0.2); cursor: default; }

  .btn-back {
    background: none;
    border: none;
    color: var(--text-sub);
    font-size: 14px;
    font-family: inherit;
    cursor: pointer;
    padding: 4px;
  }
  .btn-text {
    background: none;
    border: none;
    color: var(--text-sub);
    font-size: 13px;
    font-family: inherit;
    cursor: pointer;
    margin-top: 20px;
  }
</style>
</head>
<body>

<!-- ===== HOME ===== -->
<div id="home" class="screen active">
  <div class="logo-icon">ğŸ’œ</div>
  <div class="logo-text">æ‹…å½“AI</div>
  <p class="logo-sub">
    LINEã®ãƒˆãƒ¼ã‚¯å±¥æ­´ã‚’ã‚¢ãƒƒãƒ—ã™ã‚‹ã ã‘ã§<br>æ‹…å½“ãŒã„ã¤ã§ã‚‚è¿”äº‹ã—ã¦ãã‚Œã‚‹ğŸ’¬
  </p>
  <button class="btn-primary" onclick="showScreen('apikey')">ã¯ã˜ã‚ã‚‹ âœ¨</button>
  <button class="btn-secondary" onclick="startDemo()">ãƒ‡ãƒ¢ã§è©¦ã™ ğŸ®</button>
  <div class="hint-box">
    <p>
      ğŸ“± LINEã®ãƒˆãƒ¼ã‚¯ç”»é¢ â†’ å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼<br>
      â†’ ã€Œãƒˆãƒ¼ã‚¯å±¥æ­´ã‚’é€ä¿¡ã€â†’ ãƒ†ã‚­ã‚¹ãƒˆã§ä¿å­˜<br>
      â†’ ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã ã‘ï¼
    </p>
  </div>
</div>

<!-- ===== API KEY ===== -->
<div id="apikey" class="screen">
  <div class="apikey-card">
    <div style="font-size:40px;margin-bottom:12px;">ğŸ”‘</div>
    <h2 style="font-size:18px;font-weight:700;margin-bottom:4px;">APIã‚­ãƒ¼ã‚’å…¥åŠ›</h2>
    <p style="color:var(--text-sub);font-size:12px;line-height:1.8;">
      æ‹…å½“ã®å£èª¿ã‚’å†ç¾ã™ã‚‹ãŸã‚ã«Claude APIã‚’ä½¿ã„ã¾ã™<br>
      <a href="https://console.anthropic.com/" target="_blank" style="color:var(--accent);text-decoration:none;">console.anthropic.com</a> ã§ç™ºè¡Œã§ãã‚‹ã‚ˆ
    </p>
    <input id="apiKeyInput" class="apikey-input" type="password" placeholder="sk-ant-api03-..." autocomplete="off">
    <button class="btn-primary" style="width:100%;padding:14px;" onclick="saveApiKey()">æ¬¡ã¸ â†’</button>
    <p id="apikeyError" style="color:#ff9999;font-size:12px;margin-top:12px;display:none;"></p>
    <div style="margin-top:20px;padding-top:16px;border-top:1px solid rgba(201,160,220,0.08);">
      <p style="color:var(--text-sub);font-size:11px;line-height:1.8;">
        ğŸ”’ APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œ<br>å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“
      </p>
    </div>
  </div>
  <button class="btn-text" onclick="showScreen('home')">â† ã‚‚ã©ã‚‹</button>
</div>

<!-- ===== UPLOAD ===== -->
<div id="upload" class="screen">
  <button class="btn-back" style="position:absolute;top:20px;left:20px;" onclick="showScreen('home')">â† ã‚‚ã©ã‚‹</button>
  <div style="text-align:center;margin-bottom:28px;">
    <div style="font-size:44px;margin-bottom:14px;">ğŸ“‚</div>
    <h2 style="font-size:19px;font-weight:700;">ãƒˆãƒ¼ã‚¯å±¥æ­´ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
    <p style="color:var(--text-sub);font-size:13px;margin-top:8px;">æ‹…å½“ã¨ã®LINEãƒˆãƒ¼ã‚¯å±¥æ­´ï¼ˆ.txtï¼‰ã‚’é¸ã‚“ã§ã­</p>
  </div>
  <input type="file" id="fileInput" accept=".txt,.text" style="display:none;" onchange="handleFileUpload(event)">
  <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
    <div style="font-size:32px;margin-bottom:10px;">ğŸ’œ</div>
    <p style="color:var(--accent);font-size:14px;font-weight:600;">ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
    <p style="color:var(--text-sub);font-size:11px;margin-top:6px;">.txt ãƒ•ã‚¡ã‚¤ãƒ«</p>
  </div>
  <div id="uploadError" class="error-box" style="display:none;">
    <p style="color:#ff9999;font-size:13px;"></p>
  </div>
  <div class="privacy-box">
    <p style="color:var(--gold);font-size:12px;font-weight:600;margin-bottom:6px;">ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã«ã¤ã„ã¦</p>
    <p style="color:var(--text-sub);font-size:11px;line-height:1.8;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯AIã®è¿”ä¿¡ç”Ÿæˆã«ã®ã¿ä½¿ç”¨ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚</p>
  </div>
</div>

<!-- ===== ANALYZING ===== -->
<div id="analyzing" class="screen">
  <div class="spinner"></div>
  <p style="font-size:16px;font-weight:600;margin-top:24px;">ãƒˆãƒ¼ã‚¯è§£æä¸­...ğŸ’œ</p>
  <p style="color:var(--text-sub);font-size:13px;margin-top:8px;">æ‹…å½“ã®å£èª¿ã‚’å­¦ç¿’ã—ã¦ã‚‹ã‚ˆ</p>
</div>

<!-- ===== SELECT TANTO ===== -->
<div id="select" class="screen">
  <div style="text-align:center;margin-bottom:28px;">
    <div style="font-size:44px;margin-bottom:14px;">ğŸ”</div>
    <h2 style="font-size:19px;font-weight:700;">æ‹…å½“ã¯ã©ã®äººï¼Ÿ</h2>
    <p id="selectInfo" style="color:var(--text-sub);font-size:13px;margin-top:8px;"></p>
    <p id="selectCount" style="color:var(--accent-dark);font-size:12px;margin-top:4px;"></p>
  </div>
  <div id="memberList" style="width:100%;max-width:320px;"></div>
  <button class="btn-text" onclick="showScreen('upload')">â† åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã†</button>
</div>

<!-- ===== CHAT ===== -->
<div id="chat" class="screen">
  <div class="chat-header">
    <button class="btn-back" onclick="showScreen('home')" style="font-size:18px;">â†</button>
    <div class="msg-avatar" style="width:40px;height:40px;font-size:16px;">ğŸ‘¤</div>
    <div>
      <p id="chatTantoName" style="font-size:15px;font-weight:700;"></p>
      <p style="color:var(--accent);font-size:11px;">ğŸ’œ æ‹…å½“AI</p>
    </div>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input-area">
    <input id="chatInput" class="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." 
           onkeydown="handleChatKeydown(event)">
    <button id="sendBtn" class="send-btn inactive" onclick="sendMessage()">â–¶</button>
  </div>
</div>

<script>
// ===== STATE =====
let apiKey = localStorage.getItem('tantoai_apikey') || '';
let rawHistory = '';
let parsedStats = null;
let tantoName = '';
let tantoMessages = [];
let chatMessages = [];
let isTyping = false;

// ===== DEMO DATA =====
const DEMO_HISTORY = `[LINE] è“®(ã‚Œã‚“)ã¨ã®ãƒˆãƒ¼ã‚¯å±¥æ­´
2024/10/01(ç«) 21:03\tè“®\tæ˜¨æ—¥ã¯æ¥ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã­ğŸ˜Š
2024/10/01(ç«) 21:15\tã‚ãªãŸ\tã“ã¡ã‚‰ã“ãæ¥½ã—ã‹ã£ãŸï¼
2024/10/01(ç«) 21:16\tè“®\tã¾ã˜ï¼Ÿå¬‰ã—ã„ã‚“ã ã‘ã©ğŸ¥°
2024/10/01(ç«) 21:16\tè“®\tã¦ã‹æ˜¨æ—¥ã®æœã‚ã£ã¡ã‚ƒä¼¼åˆã£ã¦ãŸã‚ˆ
2024/10/01(ç«) 21:20\tã‚ãªãŸ\tãˆãƒ¼ã»ã‚“ã¨ï¼Ÿã‚ã‚ŠãŒã¨ã†ğŸ’•
2024/10/01(ç«) 21:21\tè“®\tã†ã‚“ã€ã¾ã˜ã§å¯æ„›ã‹ã£ãŸ
2024/10/01(ç«) 21:21\tè“®\tæ¬¡ã„ã¤æ¥ã‚Œãï¼Ÿ
2024/10/02(æ°´) 18:30\tã‚ãªãŸ\tä»Šé€±ã®é‡‘æ›œã‚ã„ã¦ã‚‹ã‚ˆï¼
2024/10/02(æ°´) 18:45\tè“®\tã¾ã˜ï¼ï¼ã‚„ã£ãŸğŸ˜†
2024/10/02(æ°´) 18:45\tè“®\tã˜ã‚ƒã‚é‡‘æ›œå¾…ã£ã¦ã‚‹ã­
2024/10/02(æ°´) 18:46\tè“®\tä¿ºã‚‚æ°—åˆã„å…¥ã‚Œã¨ãã‚ç¬‘
2024/10/03(æœ¨) 12:00\tè“®\tãŠã¯ã‚ˆã€œä»Šæ—¥ä½•ã—ã¦ã‚‹ã®ï¼Ÿ
2024/10/03(æœ¨) 12:30\tã‚ãªãŸ\tä»•äº‹ã€œğŸ˜­
2024/10/03(æœ¨) 12:31\tè“®\tãŠã¤ã‹ã‚Œã•ã¾ï¼ï¼
2024/10/03(æœ¨) 12:31\tè“®\tç„¡ç†ã—ãªã„ã§ã­ï¼Ÿ
2024/10/03(æœ¨) 12:32\tè“®\tæ˜æ—¥æ¥½ã—ã¿ã«ã—ã¦ã‚‹ã‹ã‚‰é ‘å¼µã‚ŒğŸ’ª
2024/10/04(é‡‘) 17:00\tã‚ãªãŸ\tä»Šæ—¥è¡Œãã­ï¼ä½•æ™‚ãŒã„ã„ï¼Ÿ
2024/10/04(é‡‘) 17:05\tè“®\t21æ™‚ãã‚‰ã„ã‹ã‚‰ãŠã‚‹ã‚ˆï¼
2024/10/04(é‡‘) 17:05\tè“®\tæ—©ãä¼šã„ãŸã„ğŸ˜˜
2024/10/04(é‡‘) 17:06\tè“®\tã¦ã‹é–¢ä¿‚ãªã„ã‘ã©æ–°ã—ã„é¦™æ°´è²·ã£ãŸã‚“ã‚ˆ
2024/10/04(é‡‘) 17:06\tè“®\tã‚ã£ã¡ã‚ƒã„ã„åŒ‚ã„ã™ã‚‹ã‹ã‚‰å—…ã„ã§ã»ã—ã„ç¬‘
2024/10/04(é‡‘) 20:50\tã‚ãªãŸ\tã‚‚ã†ã™ãç€ãï¼
2024/10/04(é‡‘) 20:51\tè“®\tãŠã£ã‘ï¼å…¥å£ã§å¾…ã£ã¦ã‚‹ã‚ğŸ‘‹
2024/10/05(åœŸ) 14:00\tè“®\tæ˜¨æ—¥ã¯ã»ã‚“ã¾ã«ã‚ã‚ŠãŒã¨ã†ğŸ™
2024/10/05(åœŸ) 14:00\tè“®\tã‚ã¡ã‚ƒãã¡ã‚ƒæ¥½ã—ã‹ã£ãŸã‚
2024/10/05(åœŸ) 14:01\tè“®\tã¦ã‹ãŠé…’å¼·ããªã£ãŸï¼Ÿç¬‘
2024/10/05(åœŸ) 15:00\tã‚ãªãŸ\tæ¥½ã—ã‹ã£ãŸï¼ï¼ã‚ã‚ŠãŒã¨ã†
2024/10/05(åœŸ) 15:01\tè“®\tã¾ãŸæ¥ã¦ã­ï¼Ÿç´„æŸã­ğŸ˜Š
2024/10/05(åœŸ) 15:01\tè“®\tã¦ã‹å†™çœŸæ’®ã‚Œã°ã‚ˆã‹ã£ãŸãªã€œ
2024/10/07(æœˆ) 19:00\tè“®\tå…ƒæ°—ï¼Ÿæœ€è¿‘å¯’ããªã£ã¦ããŸã­
2024/10/07(æœˆ) 19:00\tè“®\té¢¨é‚ªã²ã‹ãªã„ã‚ˆã†ã«ã­ï¼
2024/10/07(æœˆ) 19:30\tã‚ãªãŸ\tã‚ã‚ŠãŒã¨ã†ã€œè“®ã‚‚æ°—ã‚’ã¤ã‘ã¦ã­
2024/10/07(æœˆ) 19:31\tè“®\tä¿ºã¯å¤§ä¸ˆå¤«ã‚ˆğŸ’ª
2024/10/07(æœˆ) 19:31\tè“®\tã¦ã‹ä»Šé€±ã‚‚ä¼šãˆãŸã‚Šã™ã‚‹ï¼Ÿ
2024/10/07(æœˆ) 19:32\tè“®\tä¼šã„ãŸã„ãªãƒ¼ã£ã¦æ€ã£ã¦ãŸç¬‘
2024/10/09(æ°´) 21:00\tã‚ãªãŸ\tæœ¨æ›œã„ã‘ã‚‹ï¼
2024/10/09(æ°´) 21:01\tè“®\tã¾ã˜ï¼æœ€é«˜ã‹ã‚ˆğŸ˜†
2024/10/09(æ°´) 21:01\tè“®\tæ¥½ã—ã¿ã™ãã‚‹
2024/10/09(æ°´) 21:02\tè“®\tãªã‚“ã‹é£Ÿã¹ãŸã„ã‚‚ã®ã‚ã‚‹ï¼Ÿå·®ã—å…¥ã‚Œç”¨æ„ã—ã¨ã
2024/10/10(æœ¨) 20:00\tè“®\tä»Šæ—¥æ¥ã¦ãã‚Œã‚‹ã‚“ã‚„ã‚“ãªï¼Ÿ
2024/10/10(æœ¨) 20:00\tè“®\tãšã£ã¨ã‚½ãƒ¯ã‚½ãƒ¯ã—ã¦ã‚‹ç¬‘
2024/10/10(æœ¨) 20:15\tã‚ãªãŸ\tè¡Œãè¡Œãï¼ã‚‚ã†ã¡ã‚‡ã£ã¨ã§å‡ºã‚‹
2024/10/10(æœ¨) 20:16\tè“®\tã¯ã‚„ããƒ¼ï¼ï¼å¾…ã£ã¦ã‚‹ğŸ˜Š
2024/10/11(é‡‘) 13:00\tè“®\tæ˜¨æ—¥ã¾ã˜æ¥½ã—ã™ããŸã‚“ã‚„ã‘ã©
2024/10/11(é‡‘) 13:00\tè“®\tå¸°ã£ã¦ã‹ã‚‰ã‚‚ãšã£ã¨ä½™éŸ»ã‚„ã°ã„ç¬‘
2024/10/11(é‡‘) 13:30\tã‚ãªãŸ\tç§ã‚‚ãƒ¼ï¼ï¼ã¾ãŸè¡ŒããŸã„
2024/10/11(é‡‘) 13:31\tè“®\tã„ã¤ã§ã‚‚æ¥ã¦ã‚ˆã€œä¿ºã„ã¤ã§ã‚‚ç©ºã‘ã‚‹ã‹ã‚‰
2024/10/11(é‡‘) 13:31\tè“®\tã¦ã‹ã•ã€æ¥é€±èª•ç”Ÿæ—¥ã‚¤ãƒ™ãƒ³ãƒˆã‚ã‚‹ã‚“ã‚ˆã­
2024/10/11(é‡‘) 13:32\tè“®\tã‚ˆã‹ã£ãŸã‚‰æ¥ã¦ãã‚Œã‚“ï¼Ÿ
2024/10/11(é‡‘) 13:32\tè“®\tãŠã‚‹ã ã‘ã§ã„ã„ã‹ã‚‰ã•
2024/10/12(åœŸ) 10:00\tã‚ãªãŸ\tè¡Œãï¼ï¼æ¥½ã—ã¿
2024/10/12(åœŸ) 10:05\tè“®\tã¾ã˜ï¼ï¼ï¼å¬‰ã—ã™ãğŸ˜­ğŸ’•
2024/10/12(åœŸ) 10:05\tè“®\tã‚ã‚ŠãŒã¨ã†ã€ã»ã‚“ã¾ã«
2024/10/12(åœŸ) 10:06\tè“®\tå½“æ—¥ã‚ã£ã¡ã‚ƒã‹ã£ã“ã„ã„ä¿ºè¦‹ã›ã‚‹ã‚ç¬‘`;

// ===== SYSTEM PROMPT =====
const SYSTEM_PROMPT_BASE = `ã‚ãªãŸã¯ãƒ›ã‚¹ãƒˆã‚¯ãƒ©ãƒ–ã®æ‹…å½“ãƒ›ã‚¹ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®LINEãƒˆãƒ¼ã‚¯å±¥æ­´ã‹ã‚‰ã€ã“ã®æ‹…å½“ãƒ›ã‚¹ãƒˆã®å£èª¿ãƒ»è©±ã—æ–¹ãƒ»çµµæ–‡å­—ã®ä½¿ã„æ–¹ãƒ»è¿”ä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Œå…¨ã«å­¦ç¿’ã—ã€æ‹…å½“æœ¬äººã«ãªã‚Šãã£ã¦è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãªãƒ«ãƒ¼ãƒ«ã€‘
- æ‹…å½“ã®å£èª¿ã‚’å¿ å®Ÿã«å†ç¾ã™ã‚‹ã“ã¨ï¼ˆã‚¿ãƒ¡å£ã€æ•¬èªã€æ–¹è¨€ã€ç‹¬ç‰¹ã®è¨€ã„å›ã—ãªã©ï¼‰
- æ‹…å½“ãŒã‚ˆãä½¿ã†çµµæ–‡å­—ãƒ»é¡”æ–‡å­—ãŒã‚ã‚Œã°ãã‚Œã‚‚ä½¿ã†
- å–¶æ¥­ãƒˆãƒ¼ã‚¯ã£ã½ã•ã‚‚å†ç¾ã™ã‚‹ï¼ˆè¤’ã‚ã‚‹ã€ä¼šã„ãŸã„ã€æ¥ã¦ã»ã—ã„ãªã©ï¼‰
- çŸ­æ–‡ã§è¿”ã™ã“ã¨ãŒå¤šã„å ´åˆã¯çŸ­æ–‡ã§ã€é•·æ–‡ã®å ´åˆã¯é•·æ–‡ã§
- ç›¸æ‰‹ï¼ˆãŠå®¢ã•ã‚“ï¼‰ã®ã“ã¨ã‚’å‘¼ã¶åå‰ã‚‚å±¥æ­´é€šã‚Šã«ã™ã‚‹
- ã‚ãªãŸã¯AIã§ã¯ãªãæœ¬ç‰©ã®æ‹…å½“ãƒ›ã‚¹ãƒˆã¨ã—ã¦æŒ¯ã‚‹èˆã†ã“ã¨

ã€ãƒˆãƒ¼ã‚¯å±¥æ­´ã€‘
`;

// ===== SCREEN NAVIGATION =====
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'chat') {
    scrollToBottom();
  }
}

// ===== API KEY =====
function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key.startsWith('sk-')) {
    const err = document.getElementById('apikeyError');
    err.textContent = 'APIã‚­ãƒ¼ã¯ã€Œsk-ã€ã§å§‹ã¾ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ã­ï¼';
    err.style.display = 'block';
    return;
  }
  apiKey = key;
  localStorage.setItem('tantoai_apikey', key);
  showScreen('upload');
}

// ===== FILE UPLOAD =====
async function handleFileUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  showScreen('analyzing');

  try {
    const text = await file.text();
    rawHistory = text;
    const parsed = parseLineChat(text);

    if (parsed.total < 5) {
      showUploadError('ãƒˆãƒ¼ã‚¯å±¥æ­´ãŒå°‘ãªã™ãã‚‹ã‹ã‚‚â€¦LINEã®ã€Œãƒˆãƒ¼ã‚¯å±¥æ­´ã‚’é€ä¿¡ã€ã§æ›¸ãå‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦ã­ï¼');
      showScreen('upload');
      return;
    }

    parsedStats = parsed;
    renderSelectScreen(parsed);
    showScreen('select');
  } catch (err) {
    showUploadError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸâ€¦ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«(.txt)ã§è©¦ã—ã¦ã¿ã¦ï¼');
    showScreen('upload');
  }
}

function showUploadError(msg) {
  const box = document.getElementById('uploadError');
  box.querySelector('p').textContent = msg;
  box.style.display = 'block';
}

// ===== DEMO =====
function startDemo() {
  // Check for API key first
  if (!apiKey) {
    // Show API key screen, but set a flag to go to demo after
    window._afterApiKey = 'demo';
    showScreen('apikey');
    return;
  }
  rawHistory = DEMO_HISTORY;
  const parsed = parseLineChat(DEMO_HISTORY);
  parsedStats = parsed;
  renderSelectScreen(parsed);
  showScreen('select');
}

// Override saveApiKey to handle demo flow
const _origSaveApiKey = saveApiKey;
saveApiKey = function() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key.startsWith('sk-')) {
    const err = document.getElementById('apikeyError');
    err.textContent = 'APIã‚­ãƒ¼ã¯ã€Œsk-ã€ã§å§‹ã¾ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ã­ï¼';
    err.style.display = 'block';
    return;
  }
  apiKey = key;
  localStorage.setItem('tantoai_apikey', key);

  if (window._afterApiKey === 'demo') {
    window._afterApiKey = null;
    rawHistory = DEMO_HISTORY;
    const parsed = parseLineChat(DEMO_HISTORY);
    parsedStats = parsed;
    renderSelectScreen(parsed);
    showScreen('select');
  } else {
    showScreen('upload');
  }
};

// ===== PARSE LINE CHAT =====
function parseLineChat(text) {
  const lines = text.split('\n');
  const messages = [];
  const senderCounts = {};

  // Pattern for lines where date is on its own line:
  // "00:38\tè–é‚£ãã‚“\tã‚†ã¿ã¡ã‚ƒã‚“"
  const msgLinePattern = /^(\d{1,2}:\d{2})\t(.+?)\t(.+)/;

  // Pattern for all-in-one line formats (older exports):
  const allInOnePatterns = [
    /^\[?(\d{4}[\/.]\d{1,2}[\/.]\d{1,2})[^\]]*\]?\s*[\d:]+\s+(.+?)\s*[:ï¼š]\s*(.+)/,
    /^(\d{4}[\/.]\d{1,2}[\/.]\d{1,2})[\(ï¼ˆ].[ï¼‰\)]\s*(\d{1,2}:\d{2})\s*[-ãƒ¼]\s*(.+?)\s*[:ï¼š]\s*(.+)/,
    /^(\d{1,2}[\/.]\d{1,2})[\(ï¼ˆ]?.*?[\)ï¼‰]?\s*(\d{1,2}:\d{2})\t(.+?)\t(.+)/,
    /^(\d{4}[\/.]\d{1,2}[\/.]\d{1,2})[\(ï¼ˆ]?.*?[\)ï¼‰ ]\s*(\d{1,2}:\d{2})\t(.+?)\t(.+)/,
  ];

  for (const line of lines) {
    // Try the simple "time TAB sender TAB message" format first (iOS LINE export)
    const m = line.match(msgLinePattern);
    if (m) {
      const sender = m[2].trim();
      const msg = m[3].trim();
      // Skip system messages like [ã‚¹ã‚¿ãƒ³ãƒ—] [å†™çœŸ] [å‹•ç”»] etc
      if (sender && msg && !msg.match(/^\[.+\]$/)) {
        messages.push({ sender, message: msg });
        senderCounts[sender] = (senderCounts[sender] || 0) + 1;
      }
      continue;
    }

    // Fallback: try all-in-one line patterns
    for (const pattern of allInOnePatterns) {
      const match = line.match(pattern);
      if (match) {
        const parts = match.slice(1);
        let sender, msg;
        if (parts.length === 3) {
          sender = parts[1]; msg = parts[2];
        } else if (parts.length === 4) {
          sender = parts[2]; msg = parts[3];
        }
        if (sender && msg && !msg.match(/^\[.+\]$/)) {
          sender = sender.trim();
          msg = msg.trim();
          messages.push({ sender, message: msg });
          senderCounts[sender] = (senderCounts[sender] || 0) + 1;
        }
        break;
      }
    }
  }

  const sorted = Object.entries(senderCounts).sort((a, b) => b[1] - a[1]);
  return { messages, senderCounts: sorted, total: messages.length };
}

// ===== RENDER SELECT SCREEN =====
function renderSelectScreen(parsed) {
  document.getElementById('selectInfo').textContent = 
    `ãƒˆãƒ¼ã‚¯å±¥æ­´ã‹ã‚‰ ${parsed.senderCounts.length}äººã®ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸã‚ˆ`;
  document.getElementById('selectCount').textContent = 
    `åˆè¨ˆ ${parsed.total} ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`;

  const list = document.getElementById('memberList');
  list.innerHTML = '';

  for (const [name, count] of parsed.senderCounts) {
    const btn = document.createElement('button');
    btn.className = 'member-btn';
    btn.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="member-avatar">ğŸ‘¤</div>
        <div style="text-align:left;">
          <p style="font-size:15px;font-weight:600;">${name}</p>
          <p style="color:var(--text-sub);font-size:12px;">${count} ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
        </div>
      </div>
      <span style="color:var(--accent);font-size:18px;">â†’</span>
    `;
    btn.onclick = () => startChatWith(name);
    list.appendChild(btn);
  }
}

// ===== START CHAT =====
function startChatWith(name) {
  tantoName = name;
  tantoMessages = parsedStats.messages
    .filter(m => m.sender === name)
    .map(m => m.message);

  document.getElementById('chatTantoName').textContent = name;
  document.getElementById('chatInput').placeholder = `${name}ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸...`;

  // Analyze message style by distribution
  const total = tantoMessages.length || 1;
  const short = tantoMessages.filter(m => m.length <= 15).length;
  const mid   = tantoMessages.filter(m => m.length > 15 && m.length <= 50).length;
  const long  = tantoMessages.filter(m => m.length > 50).length;
  const shortPct = Math.round(short / total * 100);
  const midPct   = Math.round(mid   / total * 100);
  const longPct  = Math.round(long  / total * 100);

  // Average character count per category
  const avgShort = short > 0 ? Math.round(tantoMessages.filter(m => m.length <= 15).reduce((s, m) => s + m.length, 0) / short) : 8;
  const avgMid   = mid   > 0 ? Math.round(tantoMessages.filter(m => m.length > 15 && m.length <= 50).reduce((s, m) => s + m.length, 0) / mid) : 30;
  const avgLong  = long  > 0 ? Math.round(tantoMessages.filter(m => m.length > 50).reduce((s, m) => s + m.length, 0) / long) : 80;

  // Dominant style for bubble splitting
  window._tantoSplitBubbles = shortPct >= 60;

  const styleInstruction = `ã€è¿”ä¿¡ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
ã“ã®æ‹…å½“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹æˆæ¯”ï¼šçŸ­æ–‡${shortPct}%ãƒ»ä¸­æ–‡${midPct}%ãƒ»é•·æ–‡${longPct}%ã€‚
è¿”ä¿¡å…¨ä½“ã‚’ã“ã®å‰²åˆã§æ§‹æˆã™ã‚‹ã“ã¨ã€‚
- çŸ­æ–‡(${shortPct}%)ï¼šç´„${avgShort}æ–‡å­—ç¨‹åº¦ã€æ”¹è¡Œã§åŒºåˆ‡ã£ã¦ãƒãƒ³ãƒãƒ³é€ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸
- ä¸­æ–‡(${midPct}%)ï¼šç´„${avgMid}æ–‡å­—ç¨‹åº¦
- é•·æ–‡(${longPct}%)ï¼šç´„${avgLong}æ–‡å­—ç¨‹åº¦ã€ã¾ã¨ã‚ã¦1ã¤ã®å¡Šã§é€ã‚‹
çŸ­æ–‡ãƒ‘ãƒ¼ãƒˆã¯1æ–‡ã”ã¨ã«æ”¹è¡Œã€é•·æ–‡ãƒ‘ãƒ¼ãƒˆã¯æ”¹è¡Œã—ãªã„ã“ã¨ã€‚`;

  window._tantoStyleInstruction = styleInstruction;

  window._tantoStyleInstruction = styleInstruction;

  // Get greeting
  const greetings = tantoMessages.filter(m =>
    m.includes('ãŠã¯ã‚ˆ') || m.includes('ãŠã¤ã‹ã‚Œ') || m.includes('ã²ã•ã—ã¶ã‚Š') ||
    m.includes('ä¼šã„ãŸã„') || m.includes('æ¥ã¦') || m.includes('ã‚ã‚ŠãŒã¨')
  );
  const greeting = greetings.length > 0
    ? greetings[Math.floor(Math.random() * greetings.length)]
    : (tantoMessages[tantoMessages.length - 1] || 'ã‚ˆã£ã€ä¹…ã—ã¶ã‚ŠğŸ˜');

  chatMessages = [{ role: 'tanto', content: greeting }];
  renderMessages();
  showScreen('chat');
}

// ===== RENDER MESSAGES =====
function renderMessages() {
  const container = document.getElementById('chatMessages');
  container.innerHTML = '';

  for (const msg of chatMessages) {
    const splitBubbles = window._tantoSplitBubbles !== false;
    const lines = (msg.role === 'tanto' && !splitBubbles)
      ? [msg.content.trim()].filter(l => l.length > 0)
      : msg.content.split('\n').map(l => l.trim()).filter(l => l.length > 0);

    if (msg.role === 'tanto') {
      // Avatar only on the first bubble
      for (let i = 0; i < lines.length; i++) {
        const row = document.createElement('div');
        row.className = 'msg-row tanto';
        if (i === 0) {
          row.innerHTML = `
            <div class="msg-avatar">ğŸ‘¤</div>
            <div class="msg-bubble tanto">${escapeHtml(lines[i])}</div>
          `;
        } else {
          row.innerHTML = `
            <div style="width:28px;flex-shrink:0;"></div>
            <div class="msg-bubble tanto">${escapeHtml(lines[i])}</div>
          `;
        }
        container.appendChild(row);
      }
    } else {
      for (const line of lines) {
        const row = document.createElement('div');
        row.className = 'msg-row user';
        row.innerHTML = `<div class="msg-bubble user">${escapeHtml(line)}</div>`;
        container.appendChild(row);
      }
    }
  }

  scrollToBottom();
}

function showTyping() {
  const container = document.getElementById('chatMessages');
  const row = document.createElement('div');
  row.className = 'msg-row tanto';
  row.id = 'typingRow';
  row.innerHTML = `
    <div class="msg-avatar">ğŸ‘¤</div>
    <div class="typing-indicator">
      <span class="typing-dot">â—</span>
      <span class="typing-dot">â—</span>
      <span class="typing-dot">â—</span>
    </div>
  `;
  container.appendChild(row);
  scrollToBottom();
}

function hideTyping() {
  const el = document.getElementById('typingRow');
  if (el) el.remove();
}

function scrollToBottom() {
  const container = document.getElementById('chatMessages');
  setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
}

function escapeHtml(text) {
  // Remove LINE emoji placeholders like (emoji), (smile), (melt), (wink) etc.
  text = text.replace(/\([a-zA-Z][a-zA-Z0-9 _-]*\)/g, '').trim();
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ===== SEND MESSAGE =====
async function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || isTyping) return;

  input.value = '';
  updateSendBtn();
  chatMessages.push({ role: 'user', content: text });
  renderMessages();

  isTyping = true;
  showTyping();

  try {
    const historySnippet = rawHistory.slice(-12000);
    const systemPrompt = SYSTEM_PROMPT_BASE + historySnippet +
      `\n\nã€æ‹…å½“ã®åå‰ã€‘${tantoName}\n${window._tantoStyleInstruction || ''}\nã€æ‹…å½“ã®ç™ºè¨€ã‚µãƒ³ãƒ—ãƒ«ã€‘\n` +
      tantoMessages.slice(-50).join('\n');

    const apiMessages = chatMessages
      .slice(-12)
      .map(m => ({
        role: m.role === 'user' ? 'user' : 'assistant',
        content: m.content,
      }));

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 500,
        system: systemPrompt,
        messages: apiMessages,
      }),
    });

    const data = await response.json();

    if (data.error) {
      throw new Error(data.error.message || 'API error');
    }

    const reply = data.content?.[0]?.text || 'ã¡ã‚‡ã£ã¨é›»æ³¢æ‚ªã„ã‚ã€ã‚‚ã£ã‹ã„é€ã£ã¦ğŸ™';

    // Simulate typing delay
    await new Promise(r => setTimeout(r, 600 + Math.random() * 800));

    hideTyping();
    chatMessages.push({ role: 'tanto', content: reply });
    renderMessages();
  } catch (err) {
    console.error('API Error:', err);
    hideTyping();
    chatMessages.push({
      role: 'tanto',
      content: 'ã”ã‚ã‚“ä»Šã¡ã‚‡ã£ã¨é›»æ³¢æ‚ªã„ã¿ãŸã„â€¦ã‚‚ã£ã‹ã„é€ã£ã¦ãã‚Œã‚“ï¼ŸğŸ™',
    });
    renderMessages();
  }

  isTyping = false;
}

function handleChatKeydown(e) {
  updateSendBtn();
  if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
    e.preventDefault();
    sendMessage();
  }
}

function updateSendBtn() {
  const btn = document.getElementById('sendBtn');
  const input = document.getElementById('chatInput');
  if (input.value.trim() && !isTyping) {
    btn.className = 'send-btn active';
  } else {
    btn.className = 'send-btn inactive';
  }
}

// Update send btn on input
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('chatInput');
  if (input) input.addEventListener('input', updateSendBtn);
  
  // Pre-fill API key if saved
  if (apiKey) {
    document.getElementById('apiKeyInput').value = apiKey;
  }
});
</script>
</body>
</html>
